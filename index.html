<!DOCTYPE html>
<html>
<head>
    <title>VR Ball Collector</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    <script>
        let score = 0;
        let timeLeft = 30;
        let timerInterval;
        let currentLevel = 1;
        
        const levelConfig = {
            1: {balls: 30, speed: 1, time: 30},
            2: {balls: 40, speed: 1.5, time: 25},
            3: {balls: 50, speed: 2, time: 20}
        };

        const ballTypes = {
            red: {score: 1, effect: 'speed+', color: '#FF0000'},
            blue: {score: 2, effect: 'time+', color: '#0000FF'},
            black: {score: -1, effect: 'speed-', color: '#000000'}
        };

        function startGame() {
            const config = levelConfig[currentLevel];
            document.getElementById('play-button').setAttribute('visible', false);
            document.getElementById('timer').setAttribute('value', `Time: ${config.time}`);
            timeLeft = config.time;
            score = 0;
            resetObjects(config.balls);
            timerInterval = setInterval(updateTimer, 1000);
            document.querySelector('#backgroundMusic').components.sound.playSound();
        }

        function updateTimer() {
            timeLeft--;
            document.getElementById('timer').setAttribute('value', `Time: ${timeLeft}`);
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                endGame();
            }
        }

        function endGame() {
            document.querySelectorAll('.collectible').forEach(obj => obj.remove());
            document.getElementById('game-over').setAttribute('visible', true);
            updateHighScores();
            document.querySelector('#backgroundMusic').components.sound.stopSound();
        }

        function updateHighScores() {
            const savedScores = JSON.parse(localStorage.getItem('highScores')) || [];
            const newScores = [...savedScores, score].sort((a,b) => b-a).slice(0,5);
            localStorage.setItem('highScores', JSON.stringify(newScores));
            
            let highScoresText = 'High Scores:\n';
            newScores.forEach((s, i) => {
                highScoresText += `${i+1}. ${s}\n`;
            });
            document.getElementById('high-scores').setAttribute('value', highScoresText);
        }

        function spawnObjects(count) {
            const positions = [];
            for (let i = 0; i < count; i++) {
                positions.push({
                    x: Math.random() * 20 - 10,
                    y: 1.5,
                    z: Math.random() * 20 - 10
                });
            }
            return positions;
        }

        function resetObjects(count) {
            const colors = Object.keys(ballTypes);
            const positions = spawnObjects(count);
            
            positions.forEach(pos => {
                const type = colors[Math.floor(Math.random() * colors.length)];
                const ball = document.createElement('a-entity');
                ball.setAttribute('class', `collectible ${type}`);
                ball.setAttribute('gltf-model', '#ballModel');
                ball.setAttribute('scale', '0.5 0.5 0.5');
                ball.setAttribute('shadow', 'cast: true; receive: true');
                ball.setAttribute('position', pos);
                ball.setAttribute('animation', `property: position; dir: alternate; dur: 2000; 
                    to: ${pos.x} 2 ${pos.z}; loop: true`);
                ball.setAttribute('collectible', `type: ${type}`);
                document.querySelector('a-scene').appendChild(ball);
            });
        }

        AFRAME.registerComponent('collectible', {
            schema: {type: {default: 'red'}},
            init: function () {
                this.el.addEventListener('click', () => {
                    const explosion = document.createElement('a-entity');
                    explosion.setAttribute('particle-system', 'preset: explosion; color: yellow; duration: 500');
                    explosion.setAttribute('position', this.el.getAttribute('position'));
                    document.querySelector('a-scene').appendChild(explosion);
                    
                    document.querySelector('#collectSound').components.sound.playSound();
                    score += ballTypes[this.data.type].score;
                    document.getElementById('score').setAttribute('value', `Score: ${score}`);
                    this.el.parentNode.removeChild(this.el);
                });
            }
        });
    </script>
</head>
<body>
    <a-scene physics="debug: false" renderer="colorManagement: true; shadow: true">
        <a-assets>
            <audio id="collectSound" src="https://cdn.aframe.io/360-image-gallery-boilerplate/audio/click.ogg"></audio>
            <audio id="backgroundMusic" src="https://cdn.aframe.io/360-image-gallery-boilerplate/audio/background.ogg"></audio>
            
            <a-asset-item id="ballModel" src="https://cdn.aframe.io/test-models/models/Box/glTF-Embedded/Box.gltf"></a-asset-item>
        </a-assets>

        <!-- Lighting -->
        <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
        <a-light type="directional" color="#ffffff" intensity="0.8" 
                position="5 10 5" cast-shadow="true"></a-light>

        <!-- Environment -->
        <a-sky src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg"></a-sky>
        <a-plane position="0 0 0" rotation="-90 0 0" width="40" height="40" 
                material="shader: standard; metalness: 0.2; roughness: 0.5; color: #80ff80"
                shadow="receive: true"></a-plane>

        <!-- Player -->
        <a-entity id="player" position="0 1.6 0">
            <a-camera>
                <a-entity cursor="fuse: true; fuseTimeout: 500"
                        position="0 0 -1"
                        geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                        material="color: #00FF00; shader: flat">
                </a-entity>
            </a-camera>
            
            <!-- Левый контроллер -->
            <a-entity laser-controls="hand: left"
                    raycaster="objects: .collectible, #play-button; far: 10"
                    line="color: #ff0000; opacity: 0.8">
            </a-entity>

            <!-- Правый контроллер -->
            <a-entity laser-controls="hand: right"
                    raycaster="objects: .collectible, #play-button; far: 10"
                    line="color: #0000FF; opacity: 0.8">
            </a-entity>
        </a-entity>

        <!-- UI Elements -->
        <a-text id="timer" value="Time: 30" position="-1.5 2.5 -3" color="#FFF" scale="2 2 2"></a-text>
        <a-text id="score" value="Score: 0" position="1.5 2.5 -3" color="#FFF" scale="2 2 2"></a-text>
        <a-text id="high-scores" position="-4 1.5 -3" color="#FFF" scale="1.5 1.5 1.5"></a-text>
        <a-text id="game-over" value="Game Over!" position="0 1.5 -3" 
               color="#FF0000" scale="3 3 3" visible="false"></a-text>

        <!-- Play Button -->
        <a-entity id="play-button" position="0 1 -3"
                  geometry="primitive:cylinder; radiusBottom:.8; radiusTop:.8; height:.2"
                  material="color:#00FF00; metalness:.4; roughness:.3"
                  class="clickable">
                  
          <a-text value="START"
                   position="-0.25 .05 .01"
                   align="center"
                   color="#000"
                   scale=".7 .7 .7">
          </a-text>

          <a-animation attribute="rotation"
                       to="360 360 -360"
                       dur="20000"
                       repeat="indefinite">
          </a-animation>

          <a-event-set event='click' _='startGame()'></a-event-set>
      </a-entity>

    </a-scene>
</body>
</html>
